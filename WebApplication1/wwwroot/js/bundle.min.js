function loadCategories(){fetch("?handler=Categories").then(n=>n.json()).then(n=>{renderCategories(n)}).catch(n=>{console.error("Error loading categories:",n),document.getElementById("categoriesMenu").innerHTML='<p class="error">Ошибка загрузки категорий<\/p>'})}function renderCategories(n){if(Array.isArray(n)){const r=document.getElementById("categoriesMenu");r.innerHTML="";const u=[...new Map(n.map(n=>[n.id,n])).values()],t=new Map;u.forEach(n=>{t.set(n.id,JSON.parse(JSON.stringify(n)))});const i=[];t.forEach(n=>{if(n.parentId===-1)i.push(n);else if(t.has(n.parentId)){const i=t.get(n.parentId);i.children||(i.children=[]);i.children.some(t=>t.id===n.id)||i.children.push(n)}});i.forEach(n=>{r.appendChild(createCategoryElement(n))});console.log("Processed categories:",{originalCount:n.length,uniqueCount:u.length,rootCategories:i})}}function createCategoryElement(n){const t=document.createElement("li");t.className="category-item";const i=document.createElement("a");if(i.href="#",i.className="category-link",i.textContent=n.name,i.setAttribute("data-category-id",n.id),i.addEventListener("click",function(i){i.preventDefault();n.children&&n.children.length>0?t.classList.toggle("open"):loadProductsByCategory(n.id)}),t.appendChild(i),n.children&&n.children.length>0){t.classList.add("has-children");const i=document.createElement("ul");i.className="subcategory-list";const r=Array.from(new Set(n.children.map(n=>n.id))).map(t=>n.children.find(n=>n.id===t));r.forEach(n=>{i.appendChild(createCategoryElement(n))});t.appendChild(i)}return t}function loadProductsByCategory(n){const i=document.getElementById("initialContent"),t=document.getElementById("cardsContainer"),r=document.getElementById("loader");r.style.display="block";i.classList.remove("visible");i.classList.add("hidden");t.classList.remove("visible");t.classList.add("hidden");t.innerHTML="";fetch(`?handler=ProductsByCategory&categoryId=${n}`).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.json()}).then(n=>{n&&n.length>0?renderCards(n):t.innerHTML='<p class="no-results">Товары не найдены<\/p>'}).catch(n=>{console.error("Error:",n),t.innerHTML='<p class="error-message">Произошла ошибка при загрузке товаров<\/p>'}).finally(()=>{r.style.display="none",t.classList.remove("hidden"),t.classList.add("visible")})}function createCategoryElement(n){const t=document.createElement("li");t.className="category-item";const i=document.createElement("a");if(i.href="#",i.className="category-link",i.textContent=n.name,i.setAttribute("data-category-id",n.id),i.addEventListener("click",function(i){i.preventDefault();i.stopPropagation();n.children&&n.children.length>0?(t.classList.toggle("open"),loadProductsByCategory(n.id)):loadProductsByCategory(n.id)}),t.appendChild(i),n.children&&n.children.length>0){t.classList.add("has-children");const i=document.createElement("ul");i.className="subcategory-list";const r=Array.from(new Set(n.children.map(n=>n.id))).map(t=>n.children.find(n=>n.id===t));r.forEach(n=>{i.appendChild(createCategoryElement(n))});t.appendChild(i)}return t}function updateTime(){fetch("?handler=CurrentTime").then(n=>n.json()).then(n=>{document.getElementById("currentTime").textContent=`Time: ${n.time}`})}function searchProducts(n){const i=document.getElementById("initialContent"),t=document.getElementById("cardsContainer"),r=document.getElementById("loader");r.style.display="block";i.classList.remove("visible");i.classList.add("hidden");t.classList.remove("visible");t.classList.add("hidden");t.innerHTML="";fetch(`?handler=Search&query=${encodeURIComponent(n)}`).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.json()}).then(n=>{n&&n.length>0?renderCards(n):t.innerHTML='<p class="no-results">Товары не найдены<\/p>'}).catch(n=>{console.error("Error:",n),t.innerHTML='<p class="error-message">Произошла ошибка при поиске<\/p>'}).finally(()=>{r.style.display="none",t.classList.remove("hidden"),t.classList.add("visible")})}function isAuthenticated(){return document.cookie.includes("jwt=")}function renderCards(n){const t=document.getElementById("cardsContainer");n.forEach((n,i)=>{const r=document.createElement("div");r.className="card";const o=isAuthenticated()?`<button class="favorite-btn" data-product-id="${n.id}">❤️ Добавить в избранное</button>`:`<button disabled title="Требуется авторизация">🔒 Избранное</button>`;r.innerHTML=`
                <a href = "https://localhost:7100/Product?id=${n.id}">
                    <h3>${n.name}</h3>
                    <p>${n.description}</p>
                    <p class="price">Цена: $${n.price}</p>
                 </a>
                 <button>Добавить в корзину</button>
                 <button>Добавить в избранное</button>
                  ${o}
                `;r.style.opacity="0";r.style.transform="scale(0.95)";t.appendChild(r);const u=r.querySelector("a");u.style.textDecoration="none";u.style.color="inherit";u.style.display="block";const f=u.querySelector("h3");f.style.margin="0 0 10px 0";f.style.color="#333";f.style.fontSize="1.2em";const s=u.querySelectorAll("p");s.forEach(n=>{n.style.margin="0 0 8px 0",n.style.color="#666"});const e=u.querySelector(".price");e.style.fontWeight="bold";e.style.color="#000";setTimeout(()=>{r.style.opacity="1",r.style.transform="scale(1)"},i*100)})}function getCookie(n){const i=`; ${document.cookie}`,t=i.split(`; ${n}=`);if(t.length===2)return t.pop().split(";").shift()}document.addEventListener("DOMContentLoaded",function(){loadCategories()});setInterval(updateTime,1e3);updateTime();document.getElementById("searchForm").addEventListener("submit",function(n){n.preventDefault();const t=document.getElementById("searchInput").value.trim();t.length>0&&searchProducts(t)});document.getElementById("searchInput").addEventListener("input",function(n){const t=n.target.value.trim();if(t.length===0){const t=document.getElementById("initialContent"),n=document.getElementById("cardsContainer");n.classList.remove("visible");n.classList.add("hidden");n.innerHTML="";t.classList.remove("hidden");t.classList.add("visible")}});