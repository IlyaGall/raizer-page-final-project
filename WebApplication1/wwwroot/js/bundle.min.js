function loadCategories(){fetch("?handler=Categories").then(n=>n.json()).then(n=>{renderCategories(n)}).catch(n=>{console.error("Error loading categories:",n),document.getElementById("categoriesMenu").innerHTML='<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π<\/p>'})}function renderCategories(n){if(Array.isArray(n)){const r=document.getElementById("categoriesMenu");r.innerHTML="";const u=[...new Map(n.map(n=>[n.id,n])).values()],t=new Map;u.forEach(n=>{t.set(n.id,JSON.parse(JSON.stringify(n)))});const i=[];t.forEach(n=>{if(n.parentId===-1)i.push(n);else if(t.has(n.parentId)){const i=t.get(n.parentId);i.children||(i.children=[]);i.children.some(t=>t.id===n.id)||i.children.push(n)}});i.forEach(n=>{r.appendChild(createCategoryElement(n))});console.log("Processed categories:",{originalCount:n.length,uniqueCount:u.length,rootCategories:i})}}function createCategoryElement(n){const t=document.createElement("li");t.className="category-item";const i=document.createElement("a");if(i.href="#",i.className="category-link",i.textContent=n.name,i.setAttribute("data-category-id",n.id),i.addEventListener("click",function(i){i.preventDefault();n.children&&n.children.length>0?t.classList.toggle("open"):loadProductsByCategory(n.id)}),t.appendChild(i),n.children&&n.children.length>0){t.classList.add("has-children");const i=document.createElement("ul");i.className="subcategory-list";const r=Array.from(new Set(n.children.map(n=>n.id))).map(t=>n.children.find(n=>n.id===t));r.forEach(n=>{i.appendChild(createCategoryElement(n))});t.appendChild(i)}return t}function loadProductsByCategory(n){const i=document.getElementById("initialContent"),t=document.getElementById("cardsContainer"),r=document.getElementById("loader");r.style.display="block";i.classList.remove("visible");i.classList.add("hidden");t.classList.remove("visible");t.classList.add("hidden");t.innerHTML="";fetch(`?handler=ProductsByCategory&categoryId=${n}`).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.json()}).then(n=>{n&&n.length>0?renderCards(n):t.innerHTML='<p class="no-results">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<\/p>'}).catch(n=>{console.error("Error:",n),t.innerHTML='<p class="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤<\/p>'}).finally(()=>{r.style.display="none",t.classList.remove("hidden"),t.classList.add("visible")})}function createCategoryElement(n){const t=document.createElement("li");t.className="category-item";const i=document.createElement("a");if(i.href="#",i.className="category-link",i.textContent=n.name,i.setAttribute("data-category-id",n.id),i.addEventListener("click",function(i){i.preventDefault();i.stopPropagation();n.children&&n.children.length>0?(t.classList.toggle("open"),loadProductsByCategory(n.id)):loadProductsByCategory(n.id)}),t.appendChild(i),n.children&&n.children.length>0){t.classList.add("has-children");const i=document.createElement("ul");i.className="subcategory-list";const r=Array.from(new Set(n.children.map(n=>n.id))).map(t=>n.children.find(n=>n.id===t));r.forEach(n=>{i.appendChild(createCategoryElement(n))});t.appendChild(i)}return t}function updateTime(){fetch("?handler=CurrentTime").then(n=>n.json()).then(n=>{document.getElementById("currentTime").textContent=`Time: ${n.time}`})}function searchProducts(n){const i=document.getElementById("initialContent"),t=document.getElementById("cardsContainer"),r=document.getElementById("loader");r.style.display="block";i.classList.remove("visible");i.classList.add("hidden");t.classList.remove("visible");t.classList.add("hidden");t.innerHTML="";fetch(`?handler=Search&query=${encodeURIComponent(n)}`).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.json()}).then(n=>{n&&n.length>0?renderCards(n):t.innerHTML='<p class="no-results">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã<\/p>'}).catch(n=>{console.error("Error:",n),t.innerHTML='<p class="error-message">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ<\/p>'}).finally(()=>{r.style.display="none",t.classList.remove("hidden"),t.classList.add("visible")})}function parseJwt(n){try{const t=n.split(".")[1],i=t.replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(atob(i).split("").map(n=>"%"+("00"+n.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return null}}function getUserData(){const n=localStorage.getItem("jwtToken");return n?parseJwt(n):null}function isAuthenticated(){return localStorage.getItem("jwtToken")!==null}function getCurrentPage(){return document.body.getAttribute("data-page")||window.location.pathname}function renderCards(n){const t=document.getElementById("cardsContainer");if(!t){console.error("–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!");return}t.innerHTML="";n.forEach((n,i)=>{const r=document.createElement("div");r.className="card";const f=document.createElement("a");f.href=`/Product?id=${n.id}`;const s=document.createElement("h3");s.textContent=n.name||"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";const h=document.createElement("p");h.textContent=n.description||"";const e=document.createElement("p");e.className="price";e.textContent=`–¶–µ–Ω–∞: ${n.price||"0"} —Ä—É–±.`;const o=document.createElement("button");o.className="cart-btn";o.innerHTML="‚ô°Ô∏é –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É";o.dataset.productId=n.id;o.addEventListener("click",()=>{try{const t=await fetch("https://localhost:7175/api/Cart/AddCartProduct?productId="+n.id,{method:"POST",headers:{"Content-Type":"application/json"}});console.log(t);t.ok?(alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!"),o.innerHTML="‚ù§"):alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É")}catch(t){console.error("Error:",t);alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")}});const u=document.createElement("button");u.className="favorite-btn";isAuthenticated()?(u.innerHTML="‚ô°Ô∏é –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ",u.dataset.productId=n.id,u.addEventListener("click",()=>{try{const t=localStorage.getItem("jwtToken");if(!t){alert("–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");return}const i=await fetch("https://localhost:5011/gateway/Favorite/Add",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({UserId:userData["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"],ProductId:n.id})});alert(userData["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"]+" "+n.id);i.ok?(alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ!"),u.innerHTML="‚ù§"):alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ")}catch(t){console.error("Error:",t);alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")}})):(u.innerHTML="üîí –ò–∑–±—Ä–∞–Ω–Ω–æ–µ",u.disabled=!0,u.title="–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è");f.appendChild(s);f.appendChild(h);f.appendChild(e);r.appendChild(f);r.appendChild(o);r.appendChild(u);f.style.textDecoration="none";f.style.color="inherit";f.style.display="block";s.style.margin="0 0 10px 0";s.style.color="#333";s.style.fontSize="1.2em";[h,e].forEach(n=>{n.style.margin="0 0 8px 0",n.style.color="#666"});e.style.fontWeight="bold";e.style.color="#000";r.style.opacity="0";r.style.transform="scale(0.95)";t.appendChild(r);setTimeout(()=>{r.style.opacity="1",r.style.transform="scale(1)",r.style.transition="opacity 0.3s, transform 0.3s"},i*100)})}function logout(){localStorage.removeItem("jwtToken");window.location.href="/Login"}document.addEventListener("DOMContentLoaded",function(){loadCategories()});setInterval(updateTime,1e3);updateTime();document.getElementById("searchForm").addEventListener("submit",function(n){n.preventDefault();const t=document.getElementById("searchInput").value.trim();t.length>0&&searchProducts(t)});document.getElementById("searchInput").addEventListener("input",function(n){const t=n.target.value.trim();if(t.length===0){const t=document.getElementById("initialContent"),n=document.getElementById("cardsContainer");n.classList.remove("visible");n.classList.add("hidden");n.innerHTML="";t.classList.remove("hidden");t.classList.add("visible")}});const userData=getUserData();userData&&(console.log("User ID:",userData["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"]),console.log("Username:",userData["http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier"]),console.log("Full Name:",userData.FullName),console.log("Email:",userData.Email),console.log("Roles:",userData.role||[]));